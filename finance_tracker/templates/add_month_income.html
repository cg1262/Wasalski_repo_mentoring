{% extends "base.html" %}

{% block title %}Dodaj przychód - {{ month_name }} {{ year }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h4><i class="fas fa-plus-circle"></i> Dodaj przychód - {{ month_name }} {{ year }}</h4>
            </div>
            <div class="card-body">
                <form method="POST" id="incomeForm">
                    <div class="mb-3">
                        <label for="description" class="form-label">Opis przychodu</label>
                        <input type="text" class="form-control" id="description" name="description" required>
                    </div>

                    <!-- Wybór rodzaju przychodu -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="income_type" id="fixed_amount" value="fixed" checked onchange="toggleIncomeType()">
                            <label class="form-check-label" for="fixed_amount">
                                Stała kwota
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="income_type" id="hourly_rate" value="hourly" onchange="toggleIncomeType()">
                            <label class="form-check-label" for="hourly_rate">
                                Oblicz na podstawie godzin i stawki
                            </label>
                        </div>
                    </div>

                    <!-- Sekcja stałej kwoty -->
                    <div id="fixed_amount_section">
                        <div class="mb-3">
                            <label for="amount" class="form-label">Kwota (zł)</label>
                            <input type="number" step="0.01" class="form-control" id="amount" name="amount">
                        </div>
                    </div>

                    <!-- Sekcja kalkulacji godzinowej -->
                    <div id="hourly_section" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="hours" class="form-label">Liczba godzin</label>
                                    <input type="number" step="0.25" class="form-control" id="hours" name="hours" onchange="calculateTotal()">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="hourly_rate" class="form-label">Stawka za godzinę (zł)</label>
                                    <input type="number" step="0.01" class="form-control" id="hourly_rate" name="hourly_rate" onchange="calculateTotal()">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vat_rate" class="form-label">Stawka VAT (%)</label>
                                    <input type="number" step="0.01" class="form-control" id="vat_rate" name="vat_rate" value="23.0" onchange="calculateTotal()">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tax_rate" class="form-label">Podatek (%)</label>
                                    <input type="number" step="0.01" class="form-control" id="tax_rate" name="tax_rate" value="12.0" onchange="calculateTotal()">
                                </div>
                            </div>
                        </div>

                        <!-- Podgląd kalkulacji -->
                        <div class="card bg-light mb-3" id="calculation_preview" style="display: none;">
                            <div class="card-body">
                                <h6 class="card-title">Podgląd kalkulacji:</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <small>Kwota brutto:</small><br>
                                        <span id="gross_amount">0.00</span> zł
                                    </div>
                                    <div class="col-6">
                                        <small>VAT (23%):</small><br>
                                        <span id="vat_amount">0.00</span> zł
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-6">
                                        <small>Podatek (12%):</small><br>
                                        <span id="tax_amount">0.00</span> zł
                                    </div>
                                    <div class="col-6">
                                        <small><strong>Kwota z VAT:</strong></small><br>
                                        <strong><span id="total_amount">0.00</span> zł</strong>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <small><strong>Do ręki (po podatku):</strong></small><br>
                                        <strong class="text-success"><span id="net_amount">0.00</span> zł</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Podatek dla stałej kwoty -->
                    <div id="fixed_tax_section">
                        <div class="mb-3">
                            <label for="fixed_tax_rate" class="form-label">Podatek (%)</label>
                            <input type="number" step="0.01" class="form-control" id="fixed_tax_rate" name="tax_rate" value="12.0">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="date" class="form-label">Data</label>
                        <input type="date" class="form-control" id="date" name="date" value="{{ default_date }}" required>
                        <div class="form-text">Data będzie automatycznie ustawiona na {{ month_name }} {{ year }}</div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-save"></i> Dodaj przychód
                        </button>
                        <a href="{{ url_for('month_detail', year=year, month=month) }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Powrót do {{ month_name }} {{ year }}
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleIncomeType() {
        const fixedAmountSection = document.getElementById('fixed_amount_section');
        const hourlySection = document.getElementById('hourly_section');
        const fixedTaxSection = document.getElementById('fixed_tax_section');
        const calculationPreview = document.getElementById('calculation_preview');
        const fixedRadio = document.getElementById('fixed_amount');
        const amountInput = document.getElementById('amount');
        
        if (fixedRadio.checked) {
            // Tryb stałej kwoty
            fixedAmountSection.style.display = 'block';
            hourlySection.style.display = 'none';
            fixedTaxSection.style.display = 'block';
            calculationPreview.style.display = 'none';
            amountInput.required = true;
            
            // Wyczyść pola godzinowe
            document.getElementById('hours').value = '';
            document.getElementById('hourly_rate').value = '';
        } else {
            // Tryb godzinowy
            fixedAmountSection.style.display = 'none';
            hourlySection.style.display = 'block';
            fixedTaxSection.style.display = 'none';
            amountInput.required = false;
            amountInput.value = '';
        }
    }
    
    function calculateTotal() {
        const hours = parseFloat(document.getElementById('hours').value) || 0;
        const hourlyRate = parseFloat(document.getElementById('hourly_rate').value) || 0;
        const vatRate = parseFloat(document.getElementById('vat_rate').value) || 23.0;
        const taxRate = parseFloat(document.getElementById('tax_rate').value) || 12.0;
        
        if (hours > 0 && hourlyRate > 0) {
            // Oblicz kwoty
            const grossAmount = hours * hourlyRate;
            const vatAmount = grossAmount * (vatRate / 100);
            const totalWithVat = grossAmount + vatAmount;
            const taxAmount = grossAmount * (taxRate / 100);
            const netAmount = grossAmount - taxAmount;
            
            // Aktualizuj wyświetlanie
            document.getElementById('gross_amount').textContent = grossAmount.toFixed(2);
            document.getElementById('vat_amount').textContent = vatAmount.toFixed(2);
            document.getElementById('total_amount').textContent = totalWithVat.toFixed(2);
            document.getElementById('tax_amount').textContent = taxAmount.toFixed(2);
            document.getElementById('net_amount').textContent = netAmount.toFixed(2);
            
            // Pokaż podgląd
            document.getElementById('calculation_preview').style.display = 'block';
        } else {
            // Ukryj podgląd jeśli dane niepełne
            document.getElementById('calculation_preview').style.display = 'none';
        }
    }
    
    // Walidacja formularza
    document.getElementById('incomeForm').addEventListener('submit', function(e) {
        const fixedRadio = document.getElementById('fixed_amount');
        const amountInput = document.getElementById('amount');
        const hoursInput = document.getElementById('hours');
        const hourlyRateInput = document.getElementById('hourly_rate');
        
        if (fixedRadio.checked) {
            // Sprawdź czy kwota jest podana
            if (!amountInput.value || parseFloat(amountInput.value) <= 0) {
                e.preventDefault();
                alert('Proszę podać kwotę przychodu.');
                amountInput.focus();
                return false;
            }
        } else {
            // Sprawdź czy godziny i stawka są podane
            if (!hoursInput.value || parseFloat(hoursInput.value) <= 0) {
                e.preventDefault();
                alert('Proszę podać liczbę godzin.');
                hoursInput.focus();
                return false;
            }
            
            if (!hourlyRateInput.value || parseFloat(hourlyRateInput.value) <= 0) {
                e.preventDefault();
                alert('Proszę podać stawkę za godzinę.');
                hourlyRateInput.focus();
                return false;
            }
        }
    });
    
    // Inicjalizacja
    document.addEventListener('DOMContentLoaded', function() {
        toggleIncomeType();
    });
</script>
{% endblock %}