{% extends "base.html" %}

{% block title %}Planowane wydatki roczne - Finance Tracker Excel{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="fas fa-calendar-check"></i> Planowane wydatki roczne</h2>
            <button class="btn btn-excel-primary" data-bs-toggle="modal" data-bs-target="#addPlannedModal">
                <i class="fas fa-plus"></i> Dodaj planowany wydatek
            </button>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="excel-summary-box excel-summary-neutral">
            <h6>Łączna wartość planowana</h6>
            <h3 class="excel-number excel-currency">
                {{ "%.2f"|format(planned_expenses|selectattr('is_paid', 'equalto', 0)|sum(attribute='amount')) }}
            </h3>
            <small>Nieopłacone wydatki</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="excel-summary-box excel-summary-positive">
            <h6>Już opłacone</h6>
            <h3 class="excel-number excel-currency">
                {{ "%.2f"|format(planned_expenses|selectattr('is_paid', 'equalto', 1)|sum(attribute='amount')) }}
            </h3>
            <small>Zrealizowane wydatki</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="excel-summary-box excel-summary-warning">
            <h6>Oczekujące w tym roku</h6>
            {% set current_year = 2025 %}
            <h3>{{ planned_expenses|selectattr('planned_year', 'equalto', current_year)|selectattr('is_paid', 'equalto', 0)|list|length }}</h3>
            <small>Do opłacenia w {{ current_year }}</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="excel-summary-box excel-summary-neutral">
            <h6>Średnia miesięczna</h6>
            {% set total_unpaid = planned_expenses|selectattr('is_paid', 'equalto', 0)|sum(attribute='amount') %}
            <h3 class="excel-number excel-currency">{{ "%.2f"|format(total_unpaid / 12) }}</h3>
            <small>Rozłożone na rok</small>
        </div>
    </div>
</div>

<!-- Yearly Planned Table -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-table"></i> Lista planowanych wydatków - Excel style</h5>
                <small class="text-muted">Jak w arkuszu "Planowane rocznie wydatki"</small>
            </div>
            <div class="card-body p-0">
                {% if planned_expenses %}
                <table class="table excel-table mb-0">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Opis</th>
                            <th>Kwota</th>
                            <th>Planowany miesiąc</th>
                            <th>Kategoria</th>
                            <th>Data opłacenia</th>
                            <th>Akcje</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for planned in planned_expenses %}
                        <tr class="{% if planned.is_paid %}table-success{% elif planned.planned_year == 2025 and planned.planned_month <= 7 %}table-warning{% endif %}">
                            <td>
                                {% if planned.is_paid %}
                                    <span class="status-indicator status-active"></span>
                                    <span class="badge bg-success">Opłacone</span>
                                {% else %}
                                    <span class="status-indicator status-warning"></span>
                                    <span class="badge bg-warning">Oczekuje</span>
                                {% endif %}
                            </td>
                            <td>
                                <strong>{{ planned.description }}</strong>
                                {% if planned.is_paid %}
                                    <br><small class="text-muted">Opłacone {{ planned.actual_payment_date }}</small>
                                {% endif %}
                            </td>
                            <td class="excel-number">{{ "%.2f"|format(planned.amount) }} zł</td>
                            <td>
                                <strong>{{ month_names[planned.planned_month] }} {{ planned.planned_year }}</strong>
                                {% if planned.planned_year == 2025 and planned.planned_month == 7 %}
                                    <br><small class="text-warning"><i class="fas fa-clock"></i> Ten miesiąc!</small>
                                {% elif planned.planned_year == 2025 and planned.planned_month < 7 %}
                                    <br><small class="text-danger"><i class="fas fa-exclamation"></i> Opóźniony</small>
                                {% elif planned.planned_year == 2025 and planned.planned_month == 8 %}
                                    <br><small class="text-info"><i class="fas fa-arrow-right"></i> Następny miesiąc</small>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-primary">{{ planned.category }}</span>
                            </td>
                            <td>
                                {% if planned.is_paid %}
                                    {{ planned.actual_payment_date }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if not planned.is_paid %}
                                    <button class="btn btn-success btn-sm" onclick="markAsPaid({{ planned.id }})">
                                        <i class="fas fa-check"></i> Opłać
                                    </button>
                                {% endif %}
                                <button class="btn btn-warning btn-sm" onclick="editPlanned({{ planned.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deletePlanned({{ planned.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                        
                        <!-- Summary rows by year -->
                        {% set years = planned_expenses|map(attribute='planned_year')|unique|sort %}
                        {% for year in years %}
                        <tr style="background-color: var(--excel-gray); font-weight: bold;">
                            <td colspan="2"><strong>SUMA {{ year }}:</strong></td>
                            <td class="excel-number">
                                <strong>{{ "%.2f"|format(planned_expenses|selectattr('planned_year', 'equalto', year)|sum(attribute='amount')) }} zł</strong>
                            </td>
                            <td colspan="4">
                                <small>
                                    Opłacone: {{ "%.2f"|format(planned_expenses|selectattr('planned_year', 'equalto', year)|selectattr('is_paid', 'equalto', 1)|sum(attribute='amount')) }} zł |
                                    Pozostało: {{ "%.2f"|format(planned_expenses|selectattr('planned_year', 'equalto', year)|selectattr('is_paid', 'equalto', 0)|sum(attribute='amount')) }} zł
                                </small>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-calendar-check fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Brak planowanych wydatków</h5>
                    <p class="text-muted">Dodaj pierwsze planowane wydatki aby lepiej zarządzać budżetem</p>
                    <button class="btn btn-excel-primary" data-bs-toggle="modal" data-bs-target="#addPlannedModal">
                        <i class="fas fa-plus"></i> Dodaj pierwszy planowany wydatek
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Planned Expense Modal -->
<div class="modal fade" id="addPlannedModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Dodaj planowany wydatek</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_yearly_planned') }}" id="plannedForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="description" class="form-label">Opis wydatku</label>
                                <input type="text" class="form-control excel-input" 
                                       id="description" name="description" 
                                       placeholder="Np. Ubezpieczenie samochodu"
                                       required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="amount" class="form-label">Kwota (zł)</label>
                                <input type="number" step="0.01" class="form-control excel-input" 
                                       id="amount" name="amount" 
                                       placeholder="0.00"
                                       required onchange="updatePlannedPreview()">
                            </div>
                            
                            <div class="mb-3">
                                <label for="category" class="form-label">Kategoria</label>
                                <select class="form-control excel-input" id="category" name="category" required>
                                    <option value="">Wybierz kategorię...</option>
                                    <option value="Ubezpieczenia">Ubezpieczenia</option>
                                    <option value="Podatki">Podatki</option>
                                    <option value="Technologia">Technologia</option>
                                    <option value="Dom">Dom</option>
                                    <option value="Samochód">Samochód</option>
                                    <option value="Zdrowie">Zdrowie</option>
                                    <option value="Edukacja">Edukacja</option>
                                    <option value="Inne">Inne</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="planned_year" class="form-label">Rok</label>
                                <select class="form-control excel-input" id="planned_year" name="planned_year" required onchange="updatePlannedPreview()">
                                    <option value="">Wybierz rok...</option>
                                    <option value="2024">2024</option>
                                    <option value="2025" selected>2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="planned_month" class="form-label">Miesiąc</label>
                                <select class="form-control excel-input" id="planned_month" name="planned_month" required onchange="updatePlannedPreview()">
                                    <option value="">Wybierz miesiąc...</option>
                                    <option value="1">Styczeń</option>
                                    <option value="2">Luty</option>
                                    <option value="3">Marzec</option>
                                    <option value="4">Kwiecień</option>
                                    <option value="5">Maj</option>
                                    <option value="6">Czerwiec</option>
                                    <option value="7">Lipiec</option>
                                    <option value="8">Sierpień</option>
                                    <option value="9">Wrzesień</option>
                                    <option value="10">Październik</option>
                                    <option value="11">Listopad</option>
                                    <option value="12">Grudzień</option>
                                </select>
                            </div>
                            
                            <div class="excel-summary-box" id="plannedPreview">
                                <h6><i class="fas fa-calendar"></i> Podgląd planowanego wydatku</h6>
                                <div class="row text-start">
                                    <div class="col-12 mb-2">
                                        <strong>Kwota:</strong>
                                        <span class="float-end excel-number" id="previewPlannedAmount">0.00 zł</span>
                                    </div>
                                    <div class="col-12 mb-2">
                                        <strong>Data:</strong>
                                        <span class="float-end" id="previewPlannedDate">-</span>
                                    </div>
                                    <div class="col-12 mb-2">
                                        <strong>Za ile miesięcy:</strong>
                                        <span class="float-end" id="previewMonthsUntil">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Automatyczna integracja:</strong><br>
                        Ten wydatek zostanie automatycznie uwzględniony w projekcjach miesięcznych dla wybranego miesiąca i roku.
                        Będziesz mógł go opłacić bezpośrednio z widoku miesiąca.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-excel-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Anuluj
                    </button>
                    <button type="submit" class="btn btn-excel-primary">
                        <i class="fas fa-save"></i> Dodaj do planu
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Excel-like formulas and calculations -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-calculator"></i> Analiza planowanych wydatków (Excel-style)</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6>Rozkład według miesięcy:</h6>
                        {% for month_num in range(1, 13) %}
                        {% set month_total = planned_expenses|selectattr('planned_month', 'equalto', month_num)|selectattr('is_paid', 'equalto', 0)|sum(attribute='amount') %}
                        {% if month_total > 0 %}
                        <div class="d-flex justify-content-between">
                            <span>{{ month_names[month_num] }}:</span>
                            <span class="excel-number">{{ "%.2f"|format(month_total) }} zł</span>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    <div class="col-md-4">
                        <h6>Rozkład według kategorii:</h6>
                        {% set categories = planned_expenses|selectattr('is_paid', 'equalto', 0)|map(attribute='category')|unique %}
                        {% for category in categories %}
                        {% set cat_total = planned_expenses|selectattr('category', 'equalto', category)|selectattr('is_paid', 'equalto', 0)|sum(attribute='amount') %}
                        <div class="d-flex justify-content-between">
                            <span>{{ category }}:</span>
                            <span class="excel-number">{{ "%.2f"|format(cat_total) }} zł</span>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="col-md-4">
                        <h6>Formuły:</h6>
                        <small>
                            <strong>Średnia miesięczna:</strong><br>
                            <code>= SUMA(Nieopłacone) / 12</code><br><br>
                            <strong>Procent zrealizowany:</strong><br>
                            <code>= Opłacone / (Opłacone + Nieopłacone) * 100</code><br><br>
                            <strong>Oszczędności potrzebne miesięcznie:</strong><br>
                            <code>= Pozostałe wydatki / Pozostałe miesiące</code>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function updatePlannedPreview() {
        const amount = parseFloat(document.getElementById('amount').value) || 0;
        const year = parseInt(document.getElementById('planned_year').value);
        const month = parseInt(document.getElementById('planned_month').value);
        
        // Update preview
        document.getElementById('previewPlannedAmount').textContent = amount.toFixed(2) + ' zł';
        
        if (year && month) {
            const monthNames = ['', 'Styczeń', 'Luty', 'Marzec', 'Kwiecień', 'Maj', 'Czerwiec',
                               'Lipiec', 'Sierpień', 'Wrzesień', 'Październik', 'Listopad', 'Grudzień'];
            document.getElementById('previewPlannedDate').textContent = monthNames[month] + ' ' + year;
            
            // Calculate months until
            const now = new Date();
            const planned = new Date(year, month - 1, 1);
            const monthsUntil = (planned.getFullYear() - now.getFullYear()) * 12 + (planned.getMonth() - now.getMonth());
            
            if (monthsUntil > 0) {
                document.getElementById('previewMonthsUntil').textContent = monthsUntil + ' miesięcy';
            } else if (monthsUntil === 0) {
                document.getElementById('previewMonthsUntil').textContent = 'Ten miesiąc!';
            } else {
                document.getElementById('previewMonthsUntil').textContent = 'Przeszłość (' + Math.abs(monthsUntil) + ' miesięcy temu)';
            }
        } else {
            document.getElementById('previewPlannedDate').textContent = '-';
            document.getElementById('previewMonthsUntil').textContent = '-';
        }
        
        // Update preview box color
        const preview = document.getElementById('plannedPreview');
        if (amount === 0) {
            preview.className = 'excel-summary-box';
        } else if (amount < 500) {
            preview.className = 'excel-summary-box excel-summary-positive';
        } else if (amount < 2000) {
            preview.className = 'excel-summary-box excel-summary-neutral';
        } else {
            preview.className = 'excel-summary-box excel-summary-negative';
        }
    }
    
    function markAsPaid(plannedId) {
        if (confirm('Czy na pewno chcesz oznaczyć ten wydatek jako opłacony?')) {
            // This would make an AJAX call or redirect to payment endpoint
            alert('Funkcjonalność oznaczania jako opłacone zostanie zaimplementowana');
            // window.location.href = `/yearly_planned/${plannedId}/mark_paid`;
        }
    }
    
    function editPlanned(plannedId) {
        alert('Funkcjonalność edycji planowanego wydatku zostanie zaimplementowana');
        // Could open edit modal with pre-filled data
    }
    
    function deletePlanned(plannedId) {
        if (confirm('Czy na pewno chcesz usunąć ten planowany wydatek?\n\nUWAGA: Zostanie on również usunięty z projekcji miesięcznej.')) {
            // This would make an AJAX call or redirect to delete endpoint
            alert('Funkcjonalność usuwania planowanego wydatku zostanie zaimplementowana');
            // window.location.href = `/yearly_planned/${plannedId}/delete`;
        }
    }
    
    // Initialize form
    document.addEventListener('DOMContentLoaded', function() {
        // Set current month as default
        const now = new Date();
        document.getElementById('planned_year').value = now.getFullYear();
        document.getElementById('planned_month').value = now.getMonth() + 1;
        
        // Add change listeners
        document.getElementById('amount').addEventListener('input', updatePlannedPreview);
        document.getElementById('planned_year').addEventListener('change', updatePlannedPreview);
        document.getElementById('planned_month').addEventListener('change', updatePlannedPreview);
        
        updatePlannedPreview();
    });
    
    // Form validation
    document.getElementById('plannedForm').addEventListener('submit', function(e) {
        const description = document.getElementById('description').value.trim();
        const amount = parseFloat(document.getElementById('amount').value);
        const year = parseInt(document.getElementById('planned_year').value);
        const month = parseInt(document.getElementById('planned_month').value);
        const category = document.getElementById('category').value;
        
        let errors = [];
        
        if (!description) {
            errors.push('Opis wydatku jest wymagany');
        }
        
        if (isNaN(amount) || amount <= 0) {
            errors.push('Kwota musi być większa od 0');
        }
        
        if (!year || year < 2020 || year > 2030) {
            errors.push('Rok musi być między 2020 a 2030');
        }
        
        if (!month || month < 1 || month > 12) {
            errors.push('Miesiąc musi być wybrany');
        }
        
        if (!category) {
            errors.push('Kategoria jest wymagana');
        }
        
        if (errors.length > 0) {
            e.preventDefault();
            alert('Błędy w formularzu:\n\n' + errors.join('\n'));
            return false;
        }
        
        // Confirmation for high amounts
        if (amount > 5000) {
            if (!confirm(`Czy na pewno chcesz zaplanować wydatek na kwotę ${amount.toFixed(2)} zł?`)) {
                e.preventDefault();
                return false;
            }
        }
    });
    
    // Excel-like keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'n') {
            e.preventDefault();
            const modal = new bootstrap.Modal(document.getElementById('addPlannedModal'));
            modal.show();
        }
    });
</script>
{% endblock %}