{% extends "base.html" %}

{% block title %}{{ month_name }} {{ year }} - Finance Tracker Excel{% endblock %}

{% block content %}
<!-- Month Header with Navigation -->
<div class="row mb-3">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="fas fa-calendar"></i> {{ month_name }} {{ year }}</h2>
            <div class="btn-group">
                {% if month > 1 %}
                    <a href="{{ url_for('month_detail', year=year, month=month-1) }}" class="btn btn-excel-secondary">
                        <i class="fas fa-chevron-left"></i> 
                        {% set prev_month_names = ['', 'Styczeń', 'Luty', 'Marzec', 'Kwiecień', 'Maj', 'Czerwiec', 'Lipiec', 'Sierpień', 'Wrzesień', 'Październik', 'Listopad', 'Grudzień'] %}
                        {{ prev_month_names[month-1] }}
                    </a>
                {% else %}
                    <a href="{{ url_for('month_detail', year=year-1, month=12) }}" class="btn btn-excel-secondary">
                        <i class="fas fa-chevron-left"></i> Grudzień {{ year-1 }}
                    </a>
                {% endif %}
                
                <a href="{{ url_for('index') }}" class="btn btn-excel-primary">
                    <i class="fas fa-home"></i> Panel główny
                </a>
                
                {% if month < 12 %}
                    <a href="{{ url_for('month_detail', year=year, month=month+1) }}" class="btn btn-excel-secondary">
                        {% set next_month_names = ['', 'Styczeń', 'Luty', 'Marzec', 'Kwiecień', 'Maj', 'Czerwiec', 'Lipiec', 'Sierpień', 'Wrzesień', 'Październik', 'Listopad', 'Grudzień'] %}
                        {{ next_month_names[month+1] }} <i class="fas fa-chevron-right"></i>
                    </a>
                {% else %}
                    <a href="{{ url_for('month_detail', year=year+1, month=1) }}" class="btn btn-excel-secondary">
                        Styczeń {{ year+1 }} <i class="fas fa-chevron-right"></i>
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Excel-like Summary Row -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="excel-summary-box excel-summary-neutral">
            <h6>Przeniesienie z poprzedniego</h6>
            <h4 class="excel-number excel-currency">
                {{ "%.2f"|format(month_data.przeniesienie_z_poprzedniego if month_data else 0) }}
            </h4>
        </div>
    </div>
    <div class="col-md-3">
        <div class="excel-summary-box excel-summary-positive">
            <h6>Przychód netto</h6>
            <h4 class="excel-number excel-currency">
                {{ "%.2f"|format(month_data.przychod_netto if month_data else 0) }}
            </h4>
        </div>
    </div>
    <div class="col-md-3">
        <div class="excel-summary-box excel-summary-negative">
            <h6>Wydatki razem</h6>
            <h4 class="excel-number excel-currency">
                {{ "%.2f"|format((total_expenses + total_leasing + total_yearly_planned)) }}
            </h4>
        </div>
    </div>
    <div class="col-md-3">
        <div class="excel-summary-box {% if month_data and month_data.zostaje_na_nastepny >= 0 %}excel-summary-positive{% else %}excel-summary-negative{% endif %}">
            <h6>Zostaje na następny</h6>
            <h4 class="excel-number excel-currency">
                {{ "%.2f"|format(month_data.zostaje_na_nastepny if month_data else 0) }}
            </h4>
        </div>
    </div>
</div>

<!-- Excel-like Expenses Table -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-table"></i> Wydatki - {{ month_name }} {{ year }}</h5>
                    <a href="{{ url_for('add_month_expense', year=year, month=month) }}" class="btn btn-excel-primary btn-sm">
                        <i class="fas fa-plus"></i> Dodaj wydatek
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                <table class="table excel-table mb-0">
                    <thead>
                        <tr>
                            <th style="width: 25%;">Kategoria</th>
                            <th style="width: 35%;">Opis</th>
                            <th style="width: 15%;">Kwota</th>
                            <th style="width: 10%;">Typ</th>
                            <th style="width: 15%;">Akcje</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Real Expenses by Category -->
                        {% for category in expenses_by_category %}
                        {% if category.total_amount > 0 %}
                        <tr class="category-{{ category.category_name.lower().replace('ń', 'n').replace('ś', 's').replace('ć', 'c').replace('ł', 'l').replace('ą', 'a').replace('ę', 'e').replace('ź', 'z').replace('ż', 'z') }}">
                            <td><strong>{{ category.category_name }}</strong></td>
                            <td>
                                <small>
                                    {% for expense in detailed_expenses %}
                                        {% if expense.category == category.category_name %}
                                            {{ expense.description }}{% if not loop.last %}, {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                </small>
                            </td>
                            <td class="excel-number">{{ "%.2f"|format(category.total_amount) }} zł</td>
                            <td><span class="badge bg-success">Faktyczne</span></td>
                            <td>
                                <button class="btn btn-excel-secondary btn-sm" onclick="toggleCategoryDetails('{{ category.category_name }}')">
                                    <i class="fas fa-eye"></i> Szczegóły
                                </button>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}

                        <!-- Active Leasing for this month -->
                        {% for lease in active_leasing %}
                        <tr class="category-leasing">
                            <td><strong>Leasing</strong></td>
                            <td>{{ lease.description }}</td>
                            <td class="excel-number">{{ "%.2f"|format(lease.monthly_amount) }} zł</td>
                            <td><span class="badge bg-warning">Rata</span></td>
                            <td>
                                <button class="btn btn-success btn-sm" onclick="payLease({{ lease.id }})">
                                    <i class="fas fa-check"></i> Opłać
                                </button>
                            </td>
                        </tr>
                        {% endfor %}

                        <!-- Yearly Planned for this month -->
                        {% for planned in yearly_planned %}
                        <tr class="table-info">
                            <td><strong>Planowane roczne</strong></td>
                            <td>{{ planned.description }}</td>
                            <td class="excel-number">{{ "%.2f"|format(planned.amount) }} zł</td>
                            <td><span class="badge bg-info">Planowane</span></td>
                            <td>
                                <button class="btn btn-success btn-sm" onclick="payPlanned({{ planned.id }})">
                                    <i class="fas fa-check"></i> Opłać
                                </button>
                            </td>
                        </tr>
                        {% endfor %}

                        <!-- Summary Row (Excel-like) -->
                        <tr style="background-color: var(--excel-gray); font-weight: bold; border-top: 2px solid var(--excel-dark-gray);">
                            <td><strong>SUMA WYDATKÓW</strong></td>
                            <td></td>
                            <td class="excel-number"><strong>{{ "%.2f"|format(total_expenses + total_leasing + total_yearly_planned) }} zł</strong></td>
                            <td></td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>

                {% if not expenses_by_category and not active_leasing and not yearly_planned %}
                <div class="text-center py-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Brak wydatków w tym miesiącu</p>
                    <a href="{{ url_for('add_month_expense', year=year, month=month) }}" class="btn btn-excel-primary">
                        <i class="fas fa-plus"></i> Dodaj pierwszy wydatek
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Detailed Expenses (Collapsible sections) -->
{% for category in expenses_by_category %}
{% if category.total_amount > 0 %}
<div class="row mb-3 category-details" id="details-{{ category.category_name }}" style="display: none;">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header category-{{ category.category_name.lower().replace('ń', 'n').replace('ś', 's').replace('ć', 'c').replace('ł', 'l').replace('ą', 'a').replace('ę', 'e').replace('ź', 'z').replace('ż', 'z') }}">
                <h6><i class="fas fa-list"></i> Szczegóły - {{ category.category_name }}</h6>
            </div>
            <div class="card-body p-0">
                <table class="table excel-table mb-0 table-sm">
                    <thead>
                        <tr>
                            <th>Opis</th>
                            <th>Kwota</th>
                            <th>Powtarzalne</th>
                            <th>Akcje</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for expense in detailed_expenses %}
                        {% if expense.category == category.category_name %}
                        <tr>
                            <td>{{ expense.description }}</td>
                            <td class="excel-number">{{ "%.2f"|format(expense.amount) }} zł</td>
                            <td>
                                {% if expense.is_recurring %}
                                    <span class="badge bg-secondary">Tak</span>
                                {% else %}
                                    <span class="badge bg-light text-dark">Nie</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="deleteExpense({{ expense.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}

<!-- Excel-like Formula Display -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-calculator"></i> Formuły obliczeń (jak w Excel)</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Zostaje na następny miesiąc:</strong><br>
                        <code>= Przeniesienie + Przychód - Wydatki</code><br>
                        <small class="text-muted">
                            = {{ "%.2f"|format(month_data.przeniesienie_z_poprzedniego if month_data else 0) }} 
                            + {{ "%.2f"|format(month_data.przychod_netto if month_data else 0) }} 
                            - {{ "%.2f"|format(total_expenses + total_leasing + total_yearly_planned) }}
                            = <strong>{{ "%.2f"|format(month_data.zostaje_na_nastepny if month_data else 0) }} zł</strong>
                        </small>
                    </div>
                    <div class="col-md-6">
                        <strong>Wydatki razem:</strong><br>
                        <code>= Faktyczne + Leasing + Planowane</code><br>
                        <small class="text-muted">
                            = {{ "%.2f"|format(total_expenses) }} 
                            + {{ "%.2f"|format(total_leasing) }} 
                            + {{ "%.2f"|format(total_yearly_planned) }}
                            = <strong>{{ "%.2f"|format(total_expenses + total_leasing + total_yearly_planned) }} zł</strong>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleCategoryDetails(categoryName) {
        const detailsDiv = document.getElementById('details-' + categoryName);
        if (detailsDiv.style.display === 'none' || detailsDiv.style.display === '') {
            detailsDiv.style.display = 'block';
        } else {
            detailsDiv.style.display = 'none';
        }
    }

    function deleteExpense(expenseId) {
        if (confirm('Czy na pewno chcesz usunąć ten wydatek?')) {
            // This would be implemented with a proper route
            alert('Funkcjonalność usuwania zostanie zaimplementowana');
        }
    }

    function payLease(leaseId) {
        if (confirm('Czy na pewno chcesz opłacić tę ratę leasingową?')) {
            // This would be implemented with a proper route
            alert('Funkcjonalność opłacania leasingu zostanie zaimplementowana');
        }
    }

    function payPlanned(plannedId) {
        if (confirm('Czy na pewno chcesz opłacić ten planowany wydatek?')) {
            // This would be implemented with a proper route
            alert('Funkcjonalność opłacania planowanych wydatków zostanie zaimplementowana');
        }
    }

    // Excel-like keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl+N for new expense
        if (e.ctrlKey && e.key === 'n') {
            e.preventDefault();
            window.location.href = "{{ url_for('add_month_expense', year=year, month=month) }}";
        }
        
        // Escape to go back to main
        if (e.key === 'Escape') {
            window.location.href = "{{ url_for('index') }}";
        }
    });

    // Auto-save scroll position
    window.addEventListener('beforeunload', function() {
        sessionStorage.setItem('scrollPosition', window.scrollY);
    });

    window.addEventListener('load', function() {
        const scrollPosition = sessionStorage.getItem('scrollPosition');
        if (scrollPosition) {
            window.scrollTo(0, parseInt(scrollPosition));
            sessionStorage.removeItem('scrollPosition');
        }
    });
</script>
{% endblock %}