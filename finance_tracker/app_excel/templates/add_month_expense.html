{% extends "base.html" %}

{% block title %}Dodaj wydatek - {{ month_name }} {{ year }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-plus-circle"></i> Dodaj wydatek - {{ month_name }} {{ year }}</h4>
                <small class="text-muted">Excel-like expense entry</small>
            </div>
            <div class="card-body">
                <form method="POST" id="expenseForm">
                    <div class="row">
                        <!-- Main expense details -->
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="description" class="form-label">
                                    <i class="fas fa-edit"></i> Opis wydatku
                                </label>
                                <input type="text" class="form-control excel-input" 
                                       id="description" name="description" 
                                       placeholder="Np. Zakupy spożywcze w Biedronka" 
                                       required autofocus>
                                <div class="form-text">Opisz dokładnie na co wydałeś pieniądze</div>
                            </div>

                            <div class="mb-3">
                                <label for="category" class="form-label">
                                    <i class="fas fa-tags"></i> Kategoria
                                </label>
                                <select class="form-control excel-input" id="category" name="category" required onchange="updateCategoryColor()">
                                    <option value="">Wybierz kategorię...</option>
                                    {% for category in categories %}
                                    <option value="{{ category.name }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Wybierz odpowiednią kategorię dla tego wydatku</div>
                            </div>

                            <div class="mb-3">
                                <label for="amount" class="form-label">
                                    <i class="fas fa-money-bill-wave"></i> Kwota (zł)
                                </label>
                                <input type="number" step="0.01" class="form-control excel-input" 
                                       id="amount" name="amount" 
                                       placeholder="0.00" 
                                       required onchange="updatePreview()">
                                <div class="form-text">Podaj kwotę w złotych (z groszami jeśli potrzeba)</div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           id="is_recurring" name="is_recurring" 
                                           onchange="toggleRecurringOptions()">
                                    <label class="form-check-label" for="is_recurring">
                                        <i class="fas fa-repeat"></i> Wydatek powtarzalny
                                    </label>
                                </div>
                                <div class="form-text">Zaznacz jeśli ten wydatek będzie się powtarzał w kolejnych miesiącach</div>
                            </div>

                            <div id="recurringOptions" style="display: none;">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Wydatek powtarzalny</strong><br>
                                    Ten wydatek zostanie automatycznie dodany do kolejnych 11 miesięcy.
                                    Możesz go później edytować lub usunąć w poszczególnych miesiącach.
                                </div>
                            </div>
                        </div>

                        <!-- Excel-like preview panel -->
                        <div class="col-md-4">
                            <div id="expensePreview" class="excel-summary-box">
                                <h6><i class="fas fa-eye"></i> Podgląd wydatku</h6>
                                <div class="row text-start">
                                    <div class="col-12 mb-2">
                                        <strong>Kategoria:</strong>
                                        <span class="float-end" id="previewCategory">-</span>
                                    </div>
                                    <div class="col-12 mb-2">
                                        <strong>Kwota:</strong>
                                        <span class="float-end excel-number" id="previewAmount">0.00 zł</span>
                                    </div>
                                    <div class="col-12 mb-2">
                                        <strong>Miesiąc:</strong>
                                        <span class="float-end">{{ month_name }} {{ year }}</span>
                                    </div>
                                    <div class="col-12 mb-2" id="recurringPreview" style="display: none;">
                                        <strong>Powtarzalny:</strong>
                                        <span class="float-end text-warning">+11 miesięcy</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Category color legend -->
                            <div class="mt-3">
                                <h6>Kolory kategorii:</h6>
                                <div class="row">
                                    <div class="col-12 mb-1">
                                        <div class="category-leasing p-1 text-center">Leasing</div>
                                    </div>
                                    <div class="col-12 mb-1">
                                        <div class="category-zywnosc p-1 text-center">Żywność, Transport, etc.</div>
                                    </div>
                                    <div class="col-12 mb-1">
                                        <div class="category-vat p-1 text-center">VAT</div>
                                    </div>
                                    <div class="col-12 mb-1">
                                        <div class="category-inne p-1 text-center">Inne</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action buttons -->
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a href="{{ url_for('month_detail', year=year, month=month) }}" 
                                   class="btn btn-excel-secondary me-md-2">
                                    <i class="fas fa-arrow-left"></i> Powrót do {{ month_name }}
                                </a>
                                <button type="submit" class="btn btn-excel-primary" id="submitBtn">
                                    <i class="fas fa-save"></i> Dodaj wydatek
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Excel-like keyboard shortcuts help -->
        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-keyboard"></i> Skróty klawiszowe (jak w Excel)</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li><kbd>Tab</kbd> - Przejdź do następnego pola</li>
                            <li><kbd>Shift+Tab</kbd> - Przejdź do poprzedniego pola</li>
                            <li><kbd>Enter</kbd> - Zapisz wydatek</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li><kbd>Escape</kbd> - Powrót do miesiąca</li>
                            <li><kbd>Ctrl+S</kbd> - Zapisz wydatek</li>
                            <li><kbd>F1</kbd> - Pokaż pomoc</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function updatePreview() {
        const amount = parseFloat(document.getElementById('amount').value) || 0;
        const category = document.getElementById('category').value;
        const isRecurring = document.getElementById('is_recurring').checked;
        
        // Update preview
        document.getElementById('previewAmount').textContent = amount.toFixed(2) + ' zł';
        document.getElementById('previewCategory').textContent = category || '-';
        
        // Show/hide recurring preview
        document.getElementById('recurringPreview').style.display = isRecurring ? 'block' : 'none';
        
        // Update submit button text
        const submitBtn = document.getElementById('submitBtn');
        if (isRecurring) {
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Dodaj wydatek (12 miesięcy)';
        } else {
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Dodaj wydatek';
        }
        
        // Update preview box color based on amount
        const preview = document.getElementById('expensePreview');
        if (amount === 0) {
            preview.className = 'excel-summary-box';
        } else if (amount < 100) {
            preview.className = 'excel-summary-box excel-summary-positive';
        } else if (amount < 500) {
            preview.className = 'excel-summary-box excel-summary-neutral';
        } else {
            preview.className = 'excel-summary-box excel-summary-negative';
        }
    }
    
    function updateCategoryColor() {
        updatePreview();
    }
    
    function toggleRecurringOptions() {
        const options = document.getElementById('recurringOptions');
        const checkbox = document.getElementById('is_recurring');
        
        options.style.display = checkbox.checked ? 'block' : 'none';
        updatePreview();
    }
    
    // Excel-like keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl+S to save
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            document.getElementById('expenseForm').submit();
        }
        
        // Escape to go back
        if (e.key === 'Escape') {
            window.location.href = "{{ url_for('month_detail', year=year, month=month) }}";
        }
        
        // Enter to submit (when not in textarea)
        if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
            if (document.getElementById('expenseForm').checkValidity()) {
                e.preventDefault();
                document.getElementById('expenseForm').submit();
            }
        }
        
        // F1 for help
        if (e.key === 'F1') {
            e.preventDefault();
            alert('Pomoc:\n\n- Wypełnij wszystkie wymagane pola\n- Wybierz odpowiednią kategorię\n- Zaznacz "powtarzalny" jeśli wydatek będzie się powtarzał\n- Użyj Enter lub Ctrl+S aby zapisać');
        }
    });
    
    // Form validation with Excel-like feedback
    document.getElementById('expenseForm').addEventListener('submit', function(e) {
        const description = document.getElementById('description').value.trim();
        const category = document.getElementById('category').value;
        const amount = parseFloat(document.getElementById('amount').value);
        
        let errors = [];
        
        if (!description) {
            errors.push('Opis wydatku jest wymagany');
        }
        
        if (!category) {
            errors.push('Kategoria jest wymagana');
        }
        
        if (isNaN(amount) || amount <= 0) {
            errors.push('Kwota musi być większa od 0');
        }
        
        if (errors.length > 0) {
            e.preventDefault();
            alert('Błędy w formularzu:\n\n' + errors.join('\n'));
            return false;
        }
        
        // Confirmation for large amounts
        if (amount > 1000) {
            if (!confirm(`Czy na pewno chcesz dodać wydatek na kwotę ${amount.toFixed(2)} zł?`)) {
                e.preventDefault();
                return false;
            }
        }
        
        // Confirmation for recurring expenses
        if (document.getElementById('is_recurring').checked) {
            if (!confirm('Czy na pewno chcesz dodać ten wydatek jako powtarzalny do kolejnych 11 miesięcy?')) {
                e.preventDefault();
                return false;
            }
        }
    });
    
    // Auto-focus and tab navigation
    document.addEventListener('DOMContentLoaded', function() {
        // Focus first input
        document.getElementById('description').focus();
        
        // Add change listeners
        document.getElementById('amount').addEventListener('input', updatePreview);
        document.getElementById('category').addEventListener('change', updatePreview);
        document.getElementById('is_recurring').addEventListener('change', toggleRecurringOptions);
        
        // Initialize preview
        updatePreview();
    });
    
    // Auto-save to localStorage (draft functionality)
    function autoSave() {
        const formData = {
            description: document.getElementById('description').value,
            category: document.getElementById('category').value,
            amount: document.getElementById('amount').value,
            is_recurring: document.getElementById('is_recurring').checked
        };
        
        localStorage.setItem('expense_draft_{{ year }}_{{ month }}', JSON.stringify(formData));
    }
    
    // Load draft on page load
    function loadDraft() {
        const draft = localStorage.getItem('expense_draft_{{ year }}_{{ month }}');
        if (draft) {
            const data = JSON.parse(draft);
            document.getElementById('description').value = data.description || '';
            document.getElementById('category').value = data.category || '';
            document.getElementById('amount').value = data.amount || '';
            document.getElementById('is_recurring').checked = data.is_recurring || false;
            
            toggleRecurringOptions();
            updatePreview();
            
            if (data.description || data.amount) {
                if (confirm('Znaleziono szkic wydatku. Czy chcesz go wczytać?')) {
                    // Already loaded above
                } else {
                    localStorage.removeItem('expense_draft_{{ year }}_{{ month }}');
                    document.getElementById('expenseForm').reset();
                }
            }
        }
    }
    
    // Auto-save every 5 seconds
    setInterval(autoSave, 5000);
    
    // Load draft on page load
    window.addEventListener('load', loadDraft);
    
    // Clear draft on successful submit
    document.getElementById('expenseForm').addEventListener('submit', function() {
        localStorage.removeItem('expense_draft_{{ year }}_{{ month }}');
    });
</script>
{% endblock %}