{% extends "base.html" %}

{% block title %}Leasing - Finance Tracker Excel{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="fas fa-credit-card"></i> Zarządzanie leasingiem</h2>
            <button class="btn btn-excel-primary" data-bs-toggle="modal" data-bs-target="#addLeasingModal">
                <i class="fas fa-plus"></i> Dodaj nowy leasing
            </button>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="excel-summary-box excel-summary-negative">
            <h6>Miesięczny koszt leasingu</h6>
            <h3 class="excel-number excel-currency">{{ "%.2f"|format(total_monthly) }}</h3>
            <small>Suma wszystkich aktywnych rat</small>
        </div>
    </div>
    <div class="col-md-4">
        <div class="excel-summary-box excel-summary-neutral">
            <h6>Aktywne leasingi</h6>
            <h3>{{ leasing_list|selectattr('is_active')|list|length }}</h3>
            <small>Obecnie spłacane</small>
        </div>
    </div>
    <div class="col-md-4">
        <div class="excel-summary-box excel-summary-positive">
            <h6>Zakończone leasingi</h6>
            <h3>{{ leasing_list|selectattr('is_active', 'equalto', 0)|list|length }}</h3>
            <small>Całkowicie spłacone</small>
        </div>
    </div>
</div>

<!-- Leasing Table -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-table"></i> Lista leasingów - Excel style</h5>
            </div>
            <div class="card-body p-0">
                {% if leasing_list %}
                <table class="table excel-table mb-0">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Opis</th>
                            <th>Rata miesięczna</th>
                            <th>Spłacone</th>
                            <th>Pozostało</th>
                            <th>Kwota pozostała</th>
                            <th>Data rozpoczęcia</th>
                            <th>Data końca</th>
                            <th>Akcje</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lease in leasing_list %}
                        <tr class="{% if lease.is_active %}category-leasing{% else %}table-secondary{% endif %}">
                            <td>
                                {% if lease.is_active %}
                                    <span class="status-indicator status-active"></span>
                                    <span class="badge bg-success">Aktywny</span>
                                {% else %}
                                    <span class="status-indicator status-inactive"></span>
                                    <span class="badge bg-secondary">Zakończony</span>
                                {% endif %}
                            </td>
                            <td>
                                <strong>{{ lease.description }}</strong>
                                {% if not lease.is_active %}
                                    <br><small class="text-muted">Spłacony w całości</small>
                                {% endif %}
                            </td>
                            <td class="excel-number">{{ "%.2f"|format(lease.monthly_amount) }} zł</td>
                            <td class="text-center">
                                <div class="progress" style="height: 20px;">
                                    {% set progress = (lease.months_paid / lease.total_months * 100) %}
                                    <div class="progress-bar 
                                        {% if progress == 100 %}bg-success
                                        {% elif progress >= 75 %}bg-warning
                                        {% else %}bg-info{% endif %}" 
                                         role="progressbar" 
                                         style="width: {{ progress }}%">
                                        {{ lease.months_paid }}/{{ lease.total_months }}
                                    </div>
                                </div>
                                <small>{{ "%.1f"|format(progress) }}%</small>
                            </td>
                            <td class="text-center excel-number">{{ lease.remaining_months }}</td>
                            <td class="excel-number">{{ "%.2f"|format(lease.remaining_amount) }} zł</td>
                            <td>{{ lease.start_date }}</td>
                            <td>{{ lease.end_date }}</td>
                            <td>
                                {% if lease.is_active %}
                                    <button class="btn btn-success btn-sm" onclick="payInstallment({{ lease.id }})">
                                        <i class="fas fa-check"></i> Opłać
                                    </button>
                                    <button class="btn btn-warning btn-sm" onclick="editLeasing({{ lease.id }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                {% endif %}
                                <button class="btn btn-danger btn-sm" onclick="deleteLeasing({{ lease.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                        
                        <!-- Summary row -->
                        <tr style="background-color: var(--excel-gray); font-weight: bold; border-top: 2px solid var(--excel-dark-gray);">
                            <td colspan="2"><strong>SUMA AKTYWNYCH:</strong></td>
                            <td class="excel-number"><strong>{{ "%.2f"|format(total_monthly) }} zł</strong></td>
                            <td colspan="6"></td>
                        </tr>
                    </tbody>
                </table>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-credit-card fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Brak leasingów</h5>
                    <p class="text-muted">Dodaj pierwszy leasing aby rozpocząć śledzenie rat</p>
                    <button class="btn btn-excel-primary" data-bs-toggle="modal" data-bs-target="#addLeasingModal">
                        <i class="fas fa-plus"></i> Dodaj pierwszy leasing
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Leasing Modal -->
<div class="modal fade" id="addLeasingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Dodaj nowy leasing</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_leasing') }}" id="leasingForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="description" class="form-label">Opis leasingu</label>
                                <input type="text" class="form-control excel-input" 
                                       id="description" name="description" 
                                       placeholder="Np. Samochód Toyota Corolla"
                                       required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="monthly_amount" class="form-label">Rata miesięczna (zł)</label>
                                <input type="number" step="0.01" class="form-control excel-input" 
                                       id="monthly_amount" name="monthly_amount" 
                                       placeholder="0.00"
                                       required onchange="calculateLeasing()">
                            </div>
                            
                            <div class="mb-3">
                                <label for="total_months" class="form-label">Liczba rat (miesięcy)</label>
                                <input type="number" class="form-control excel-input" 
                                       id="total_months" name="total_months" 
                                       placeholder="36"
                                       min="1" max="120"
                                       required onchange="calculateLeasing()">
                            </div>
                            
                            <div class="mb-3">
                                <label for="start_date" class="form-label">Data rozpoczęcia</label>
                                <input type="date" class="form-control excel-input" 
                                       id="start_date" name="start_date" 
                                       required onchange="calculateLeasing()">
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="excel-summary-box" id="leasingPreview">
                                <h6><i class="fas fa-calculator"></i> Podgląd leasingu</h6>
                                <div class="row text-start">
                                    <div class="col-12 mb-2">
                                        <strong>Rata miesięczna:</strong>
                                        <span class="float-end excel-number" id="previewMonthly">0.00 zł</span>
                                    </div>
                                    <div class="col-12 mb-2">
                                        <strong>Liczba rat:</strong>
                                        <span class="float-end" id="previewMonths">0</span>
                                    </div>
                                    <div class="col-12 mb-2">
                                        <strong>Kwota całkowita:</strong>
                                        <span class="float-end excel-number" id="previewTotal">0.00 zł</span>
                                    </div>
                                    <div class="col-12 mb-2">
                                        <strong>Data zakończenia:</strong>
                                        <span class="float-end" id="previewEndDate">-</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <h6>Wpływ na budżet miesięczny:</h6>
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    Ten leasing zostanie automatycznie uwzględniony w projekcjach miesięcznych dla wszystkich miesięcy do daty zakończenia.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-excel-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Anuluj
                    </button>
                    <button type="submit" class="btn btn-excel-primary">
                        <i class="fas fa-save"></i> Dodaj leasing
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Excel-like formulas -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-calculator"></i> Formuły obliczeń leasingu (Excel-style)</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Kwota całkowita leasingu:</strong><br>
                        <code>= Rata miesięczna × Liczba rat</code><br>
                        <small class="text-muted">Całkowity koszt leasingu przez cały okres</small>
                    </div>
                    <div class="col-md-6">
                        <strong>Miesięczny koszt wszystkich leasingów:</strong><br>
                        <code>= SUMA(Raty aktywnych leasingów)</code><br>
                        <small class="text-muted">Łączny miesięczny koszt wszystkich aktywnych leasingów</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function calculateLeasing() {
        const monthlyAmount = parseFloat(document.getElementById('monthly_amount').value) || 0;
        const totalMonths = parseInt(document.getElementById('total_months').value) || 0;
        const startDate = document.getElementById('start_date').value;
        
        // Update preview
        document.getElementById('previewMonthly').textContent = monthlyAmount.toFixed(2) + ' zł';
        document.getElementById('previewMonths').textContent = totalMonths;
        document.getElementById('previewTotal').textContent = (monthlyAmount * totalMonths).toFixed(2) + ' zł';
        
        // Calculate end date
        if (startDate && totalMonths > 0) {
            const start = new Date(startDate);
            const end = new Date(start);
            end.setMonth(end.getMonth() + totalMonths - 1);
            document.getElementById('previewEndDate').textContent = end.toLocaleDateString('pl-PL');
        } else {
            document.getElementById('previewEndDate').textContent = '-';
        }
        
        // Update preview box color
        const preview = document.getElementById('leasingPreview');
        const total = monthlyAmount * totalMonths;
        
        if (total === 0) {
            preview.className = 'excel-summary-box';
        } else if (total < 10000) {
            preview.className = 'excel-summary-box excel-summary-positive';
        } else if (total < 50000) {
            preview.className = 'excel-summary-box excel-summary-neutral';
        } else {
            preview.className = 'excel-summary-box excel-summary-negative';
        }
    }
    
    function payInstallment(leasingId) {
        if (confirm('Czy na pewno chcesz opłacić ratę tego leasingu?')) {
            // This would make an AJAX call or redirect to payment endpoint
            alert('Funkcjonalność opłacania raty zostanie zaimplementowana');
            // window.location.href = `/leasing/${leasingId}/pay`;
        }
    }
    
    function editLeasing(leasingId) {
        alert('Funkcjonalność edycji leasingu zostanie zaimplementowana');
        // Could open edit modal or redirect to edit page
    }
    
    function deleteLeasing(leasingId) {
        if (confirm('Czy na pewno chcesz usunąć ten leasing?\n\nUWAGA: Zostanie on również usunięty z wszystkich projekcji miesięcznych.')) {
            // This would make an AJAX call or redirect to delete endpoint
            alert('Funkcjonalność usuwania leasingu zostanie zaimplementowana');
            // window.location.href = `/leasing/${leasingId}/delete`;
        }
    }
    
    // Set today's date as default
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('start_date').value = today;
        
        // Add change listeners
        document.getElementById('monthly_amount').addEventListener('input', calculateLeasing);
        document.getElementById('total_months').addEventListener('input', calculateLeasing);
        document.getElementById('start_date').addEventListener('change', calculateLeasing);
        
        calculateLeasing();
    });
    
    // Form validation
    document.getElementById('leasingForm').addEventListener('submit', function(e) {
        const description = document.getElementById('description').value.trim();
        const monthlyAmount = parseFloat(document.getElementById('monthly_amount').value);
        const totalMonths = parseInt(document.getElementById('total_months').value);
        
        let errors = [];
        
        if (!description) {
            errors.push('Opis leasingu jest wymagany');
        }
        
        if (isNaN(monthlyAmount) || monthlyAmount <= 0) {
            errors.push('Rata miesięczna musi być większa od 0');
        }
        
        if (isNaN(totalMonths) || totalMonths <= 0 || totalMonths > 120) {
            errors.push('Liczba rat musi być między 1 a 120');
        }
        
        if (errors.length > 0) {
            e.preventDefault();
            alert('Błędy w formularzu:\n\n' + errors.join('\n'));
            return false;
        }
        
        // Confirmation for high amounts
        const total = monthlyAmount * totalMonths;
        if (total > 100000) {
            if (!confirm(`Czy na pewno chcesz dodać leasing o łącznej wartości ${total.toFixed(2)} zł?`)) {
                e.preventDefault();
                return false;
            }
        }
    });
    
    // Excel-like keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'n') {
            e.preventDefault();
            const modal = new bootstrap.Modal(document.getElementById('addLeasingModal'));
            modal.show();
        }
    });
</script>
{% endblock %}